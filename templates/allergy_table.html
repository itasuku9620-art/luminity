{% extends 'base.html' %}
{% block title %}アレルギー表 | {{ super() }}{% endblock %}

{% block head %}
{{ super() }}
<style>
  /* ===== 見た目・レイアウト ===== */
  :root{
    --grid:#e7ecf0;
    --ok:#16a34a;   /* 緑 */
    --ng:#ef4444;   /* 赤 */
    --na:#9aa3af;
    --hi:#fff7e6;   /* ユーザー対象列のハイライト */
    --menu-col:240px;
    --data-col:110px;
  }

  .table-wrap{
    border:1px solid var(--grid);
    border-radius:12px;
    overflow:auto;
    background:#fff;
  }

  table.sheet{
    border-collapse:separate;
    border-spacing:0;
    width:100%;
    table-layout:fixed;
  }

  table.sheet col.menu-col{ width:var(--menu-col); }
  table.sheet col.data-col{ width:var(--data-col); }

  th,td{
    border-bottom:1px solid var(--grid);
    border-right:1px solid var(--grid);
    padding:10px 12px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    background-clip:padding-box;
  }

  thead th{ position:sticky; top:0; z-index:5; background:#fff; }
  tbody th{ position:sticky; left:0; z-index:6; background:#fff; }
  thead th.sticky-corner{ left:0; z-index:7; outline:1px solid var(--grid); }

  .col-menu{ font-weight:800; }
  .col-aller.hi{ background:var(--hi); }

  .mark{ text-align:center; font-weight:800; }
  .mark.ok{ color:var(--ng); }  /* ◯＝使用 → 赤 */
  .mark.ng{ color:var(--ok); }  /* ✕＝不使用 → 緑 */
  .mark.na{ color:var(--na); }

  /* ===== 凡例 ===== */
  .legend{
    margin:4px 0 12px;
    font-size:13px;
    color:#374151;
  }
  .legend .mark{
    margin:0 4px;
  }
</style>
{% endblock %}

{% block content %}

<h1 style="margin:10px 0 4px">アレルギー表</h1>

<!-- ▼ タイトル直下に凡例を表示 -->
<div class="legend">
  凡例：
  <span class="mark ng">✕＝不使用</span> /
  <span class="mark ok">◯＝使用</span> /
  <span class="mark na">－＝不明</span>
</div>

<div class="table-wrap" role="region" aria-label="アレルギー表（横スクロール可）">
  <table class="sheet">
    <colgroup>
      <col class="menu-col">
      {% for _ in allergens %}<col class="data-col">{% endfor %}
    </colgroup>

    <thead>
      <tr>
        <th class="col-menu sticky-corner">メニュー</th>
        {% for a in allergens %}
          <th class="col-aller {% if user_allergens and a in user_allergens %}hi{% endif %}">
            {{ a }}
          </th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for r in rows %}
        <tr>
          <th class="col-menu">{{ r.menu }}</th>
          {% for a in allergens %}
            {% set v = r.get(a) or '－' %}
            {% set cls = 'ok' if v=='◯' else ('ng' if v=='✕' else 'na') %}
            <td class="mark {{ cls }}">{{ v }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<a class="btn" href="{{ url_for('report_new') }}?kind=allergy&id={{ store.id }}">
  アレルギー表の誤りを報告
</a>

{% endblock %}
